/*! recline.deeplink v0.1 */
this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},this.recline.DeepLink.Deps=this.recline.DeepLink.Deps||{},function(a,b,c){"use strict";c.Map=function(a,c){var d=this;d.name="map",d.alterState=function(b){return"map"===b.currentView&&(b[d.name]={bounds:a.getBounds()}),b},d.updateURL=function(){c.updateURL(null)},d.update=function(c){if(a&&c&&c.map){var d=b.map(b.values(c.map.bounds),b.values);setTimeout(a.fitBounds.bind(a,d),0)}},a.on("dragend",d.updateURL),a.on("zoomend",d.updateURL)}}(jQuery,_,this.recline.DeepLink.Deps),this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},function(a,b){"use strict";b.Router=function(a,c){function d(a){var b=_.rest(_.toArray(arguments));return function(c){return _.isFunction(c[a])&&c[a].apply(c,b)}}var e,f,g,h,i=this,j=DeepDiff.noConflict(),k={},l={};i._init=function(a){var b=i.transform(a,i.toState);_.each(l,d("update",b)),g.init(b)},i.addDependency=function(a){l[a.name]=a},i.transform=function(a,b){var c;try{c=b(a)}catch(d){c=null}return c},i.toState=function(a){var b=e.inflate(decodeURI(a));return JSON.parse(b)},i.toParams=function(a){var b=_.omit(a.attributes,g.ignoredKeys),c=JSON.stringify(b);return e.compress(c)},i.updateURL=function(){var b,c=_.omit(a.attributes,"dataset"),d=j.diff(h,c),e={};_.each(d,function(a){"E"===a.kind?i.createNestedObject(e,a.path,a.rhs):"A"===a.kind&&i.createNestedObject(e,a.path,a)}),b=new recline.Model.ObjectState,b.attributes=e,b.attributes=i.alterState(b.attributes),k=b,f.navigate(i.transform(b,i.toParams)),g.stateChange(k,c)},i.alterState=function(a){if(_.isEmpty(l))return a;var b=_.compose.apply(null,_.without(_.map(l,function(a){return a.alterState}),void 0));return b(a)},i.createNestedObject=function(a,b,c){for(var d=_.clone(b),e=3===arguments.length?d.pop():!1,f=0;f<d.length;f++)a=a[d[f]]=a[d[f]]||{};return!e||_.isArray(c)||_.isObject(c)||(a=a[e]=c),_.isObject(c)&&"A"===c.kind&&(_.isUndefined(a[e])&&(a[e]=[]),"N"===c.item.kind&&(a=a[e][c.index]=c.item.rhs),"D"===c.item.kind&&(a[e].splice(c.index,c.item.rhs),a=a[e])),a},i.start=function(d){g=d;var j=Backbone.Router.extend({routes:{"*state":"defaultRoute"},defaultRoute:i._init});e=d.parser?new d.parser:new b.Parser,h=c||_.omit(JSON.parse(JSON.stringify(a.attributes)),d.ignoredKeys),_.each(g.listenTo,function(a){a.on("all",i.updateURL)}),f=new j,Backbone.history.start()}},b.Parser=function(){var a=this;a.compress=function(b){return a.escapeStrings(b)},a.inflate=function(b){return a.parseStrings(b)},a.escapeStrings=function(a){return a=a.replace(/"([a-zA-Z-_.]+)"\s?:/g,"$1:"),a=a.replace(/\x20(?![^"]*("[^"]*"[^"]*)*$)/g,"++"),a.replace(/"([a-zA-Z0-9-#_.-|+]+)?"/g,"!$1")},a.parseStrings=function(a){return a=a.replace(/([a-zA-Z-_.\+]+)\s?:/g,'"$1":'),a=a.replace(/![a-zA-Z0-9_. -\+]+/g,function(a){return a.replace(/\+\+/g," ")}),a.replace(new RegExp("!([a-zA-Z0-9-_# .-]+)?","g"),'"$1"')}}}(jQuery,this.recline.DeepLink);