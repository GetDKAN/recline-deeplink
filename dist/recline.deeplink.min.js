/*! recline.deeplink v0.1 */
this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},this.recline.DeepLink.Deps=this.recline.DeepLink.Deps||{},function(a,b,c){"use strict";c.Map=function(a,c){var d=this;d.name="map",d.alterState=function(b){return"map"===b.currentView&&(b[d.name]={bounds:a.getBounds()}),b},d.updateUrl=function(){c.onStateChange(null)},d.update=function(c){if(a&&c&&c.map){var d=b.map(b.values(c.map.bounds),b.values);setTimeout(a.fitBounds.bind(a,d),0)}},a.on("dragend",d.updateUrl),a.on("zoomend",d.updateUrl)}}(jQuery,_,this.recline.DeepLink.Deps),this.recline=this.recline||{},this.recline.DeepLink=this.recline.DeepLink||{},function(a,b){"use strict";b.Router=function(a,c){var d,e,f=this,g=new b.Parser,h=DeepDiff.noConflict(),i=c||_.omit(JSON.parse(JSON.stringify(a)),"dataset"),j={},k={};f.addDependency=function(a){k[a.name]=a},f.transform=function(a,b){var c;try{c=b(a)}catch(d){c=null}return c},f.toState=function(a){var b=g.inflate(decodeURI(a));return JSON.parse(b)},f.toParams=function(a){var b=JSON.stringify(_.omit(a.attributes,"dataset"));return g.compress(b)},f.onStateChange=function(){var b,c=_.omit(a.attributes,"dataset"),g=h.diff(i,c),k={};_.each(g,function(a){"E"===a.kind?f.createNestedObject(k,a.path,a.rhs):"A"===a.kind&&f.createNestedObject(k,a.path,a)}),b=new recline.Model.ObjectState,b.attributes=k,b.attributes=f.alterState(b.attributes),j=b,d.navigate(f.transform(b,f.toParams)),e.stateChange(j,c)},f.alterState=function(a){if(_.isEmpty(k))return a;var b=_.compose.apply(null,_.without(_.map(k,function(a){return a.alterState}),void 0));return b(a)},f.createNestedObject=function(a,b,c){for(var d=_.clone(b),e=3===arguments.length?d.pop():!1,f=0;f<d.length;f++)a=a[d[f]]=a[d[f]]||{};return!e||_.isArray(c)||_.isObject(c)||(a=a[e]=c),_.isObject(c)&&"A"===c.kind&&(_.isUndefined(a[e])&&(a[e]=[]),"N"===c.item.kind&&(a=a[e][c.index]=c.item.rhs),"D"===c.item.kind&&(a[e].splice(c.index,c.item.rhs),a=a[e])),a},f.start=function(b){e=b;var c=Backbone.Router.extend({routes:{"*state":"defaultRoute"},defaultRoute:e.init});d=new c,a.listenTo(a,"all",f.onStateChange),Backbone.history.start()}},b.Parser=function(){var a=this;a.compress=function(b){return a.escapeStrings(b)},a.inflate=function(b){return a.parseStrings(b)},a.escapeStrings=function(a){return a=a.replace(/"([a-zA-Z-_.]+)"\s?:/g,"$1:"),a=a.replace(/\x20(?![^"]*("[^"]*"[^"]*)*$)/g,"++"),a.replace(/"([a-zA-Z0-9-#_.-|+]+)?"/g,"!$1")},a.parseStrings=function(a){return a=a.replace(/([a-zA-Z-_.\+]+)\s?:/g,'"$1":'),a=a.replace(/![a-zA-Z0-9_. -\+]+/g,function(a){return a.replace(/\+\+/g," ")}),a.replace(new RegExp("!([a-zA-Z0-9-_# .-]+)?","g"),'"$1"')}}}(jQuery,this.recline.DeepLink);